= NetworkPolicies for Logging Components

The Cluster Logging Operator automatically creates and manages `NetworkPolicy` resources for its logging components to ensure they function in restrictive network environments, even if a cluster-wide `AdminNetworkPolicy` would otherwise block their traffic.

== Overview

When logging components are deployed, the operator can create permissive `NetworkPolicy` resources to ensure proper functionality even when:

* Restrictive default `NetworkPolicies` are in place
* `AdminNetworkPolicy` configurations limit pod communications
* Namespace-level network restrictions are applied

The `NetworkPolicy` resources are automatically created, updated, and removed along with the component deployment lifecycle.

== Collector NetworkPolicy

When a `ClusterLogForwarder` is deployed and a network policy rule set is specified, the operator creates a `NetworkPolicy` for the collector pods. The policy behavior can be configured using the `networkPolicy.ruleSet` field in the collector specification. If `spec.collector.networkPolicy` is not specified, the operator will not create a `NetworkPolicy` for the collector.

=== Rule Set Types

The collector supports the following network policy rule set types:

* **`AllowAllIngressEgress`**: Allows all ingress and egress traffic
* **`RestrictIngressEgress`**: Restricts traffic to specific ports based on the configured inputs,  outputs, and the metrics port.

=== Configuration

==== Permissive Behavior (`AllowAllIngressEgress`)

When configured with `AllowAllIngressEgress`, the operator creates a permissive `NetworkPolicy` that allows all ingress and egress traffic.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: collector-<COLLECTOR-INSTANCE-NAME>
  namespace: <COLLECTOR-NAMESPACE>
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/instance: <COLLECTOR-INSTANCE-NAME>
    app.kubernetes.io/component: collector
    app.kubernetes.io/part-of: cluster-logging
    app.kubernetes.io/managed-by: cluster-logging-operator
    app.kubernetes.io/version: <CLO-VERSION>
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vector
      app.kubernetes.io/instance: <COLLECTOR-INSTANCE-NAME>
      app.kubernetes.io/component: collector
      app.kubernetes.io/part-of: cluster-logging
      app.kubernetes.io/managed-by: cluster-logging-operator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - {}  # Allow all ingress traffic
  egress:
    - {}  # Allow all egress traffic
```

==== Restricted Behavior (`RestrictIngressEgress`)

When configured with `RestrictIngressEgress`, the network policy restricts traffic to only the necessary ports based on your configured inputs, outputs, and the metrics port.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: collector-<COLLECTOR-INSTANCE-NAME>
  namespace: <COLLECTOR-NAMESPACE>
  labels:
    app.kubernetes.io/name: vector
    app.kubernetes.io/instance: <COLLECTOR-INSTANCE-NAME>
    app.kubernetes.io/component: collector
    app.kubernetes.io/part-of: cluster-logging
    app.kubernetes.io/managed-by: cluster-logging-operator
    app.kubernetes.io/version: <CLO-VERSION>
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vector
      app.kubernetes.io/instance: <COLLECTOR-INSTANCE-NAME>
      app.kubernetes.io/component: collector
      app.kubernetes.io/part-of: cluster-logging
      app.kubernetes.io/managed-by: cluster-logging-operator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - ports:
        - port: metrics  # Always allowed for metrics collection
          protocol: TCP
        # Additional ports are added based on configured inputs
  egress:
    - ports:
        # Ports are added based on configured outputs and their protocols
```

==== How to Configure Network Policy Rule Sets

To configure the network policy rule set for a collector, specify it in the `ClusterLogForwarder` specification under `spec.collector.networkPolicy.ruleSet`:

```yaml
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: my-forwarder
  namespace: openshift-logging
spec:
  collector:
    networkPolicy:
      ruleSet: RestrictIngressEgress  # or AllowAllIngressEgress
  # ... other configuration
```

== LogFileMetricExporter NetworkPolicy

When a `LogFileMetricExporter` is deployed and a network policy rule set is specified, the operator creates a `NetworkPolicy` for the metric exporter pods. The policy behavior can be configured using the `networkPolicy.ruleSet` field in the LogFileMetricExporter specification. If `spec.logFileMetricExporter.networkPolicy` is not specified, the operator will not create a `NetworkPolicy` for the metric exporter.

=== Rule Set Types

The LogFileMetricExporter supports the following network policy rule set types:

* **`AllowIngressMetrics`**: Allows ingress traffic only on the metrics port, denies all egress traffic
* **`AllowAllIngressEgress`**: Allows all ingress and egress traffic

=== Configuration

==== Restricted Behavior (`AllowIngressMetrics`)

When configured with `AllowIngressMetrics`, the operator creates a `NetworkPolicy` that allows only metrics collection.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: lfme-<LFME-INSTANCE-NAME>
  namespace: <LFME-NAMESPACE>
  labels:
    app.kubernetes.io/name: logfilesmetricexporter
    app.kubernetes.io/instance: <LFME-INSTANCE-NAME>
    app.kubernetes.io/component: logfilesmetricexporter
    app.kubernetes.io/part-of: cluster-logging
    app.kubernetes.io/managed-by: cluster-logging-operator
    app.kubernetes.io/version: <CLO-VERSION>
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: logfilesmetricexporter
      app.kubernetes.io/instance: <LFME-INSTANCE-NAME>
      app.kubernetes.io/component: logfilesmetricexporter
      app.kubernetes.io/part-of: cluster-logging
      app.kubernetes.io/managed-by: cluster-logging-operator
  policyTypes:
    - Ingress
    - Egress  # Egress policy type is added to deny all egress traffic by default
  ingress:
    - ports:
        - port: metrics  # Allow ingress only on the metrics port
          protocol: TCP
  # No egress rules defined - this denies all egress traffic
```

==== Permissive Behavior (`AllowAllIngressEgress`)

When configured with `AllowAllIngressEgress`, the `LogFileMetricExporter` network policy allows all ingress and egress traffic:

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: lfme-<LFME-INSTANCE-NAME>
  namespace: <LFME-NAMESPACE>
  labels:
    app.kubernetes.io/name: logfilesmetricexporter
    app.kubernetes.io/instance: <LFME-INSTANCE-NAME>
    app.kubernetes.io/component: logfilesmetricexporter
    app.kubernetes.io/part-of: cluster-logging
    app.kubernetes.io/managed-by: cluster-logging-operator
    app.kubernetes.io/version: <CLO-VERSION>
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: logfilesmetricexporter
      app.kubernetes.io/instance: <LFME-INSTANCE-NAME>
      app.kubernetes.io/component: logfilesmetricexporter
      app.kubernetes.io/part-of: cluster-logging
      app.kubernetes.io/managed-by: cluster-logging-operator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - {}  # Allow all ingress traffic
  egress:
    - {}  # Allow all egress traffic
```

==== How to Configure LogFileMetricExporter Network Policy Rule Sets

To configure the network policy rule set for a `LogFileMetricExporter`, specify it in the `LogFileMetricExporter` specification under `spec.networkPolicy.ruleSet`:

```yaml
apiVersion: logging.openshift.io/v1alpha1
kind: LogFileMetricExporter
metadata:
  name: my-lfme
  namespace: openshift-logging
spec:
  networkPolicy:
    ruleSet: AllowAllIngressEgress  # or AllowIngressMetrics
  # ... other configuration
```

NOTE: The LogFileMetricExporter NetworkPolicy includes both ingress and egress policy types. In the default `AllowIngressMetrics` mode, egress is denied by having an egress policy type with no rules, providing better security isolation.

== AdminNetworkPolicy Delegation

When an `AdminNetworkPolicy` (ANP) is used in your cluster to enforce network restrictions, you may need to configure delegation to allow the logging components' `NetworkPolicy` resources to take precedence for their traffic.

=== Understanding the Hierarchy

OpenShift network policy precedence (highest to lowest priority):

1. **AdminNetworkPolicy** - Cluster-admin controlled, highest priority
2. **BaselineAdminNetworkPolicy** - Default fallback rules  
3. **NetworkPolicy** - Namespace-level policies (where logging component policies reside)

=== Delegation Configuration

To ensure logging component pods can communicate properly when an `AdminNetworkPolicy` is blocking traffic, create `AdminNetworkPolicy` rules that delegate to `NetworkPolicy` for each component:

==== Example: Delegating Collector Traffic (`AllowAllIngressEgress`)

```yaml
apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: allow-logging-collector-delegation
spec:
  priority: 50  # Adjust based on your cluster's ANP priority scheme. Lower number means higher priority
  subject:
    pods: # Target all collector pods in any namespace
      namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: vector
          app.kubernetes.io/managed-by: cluster-logging-operator
          app.kubernetes.io/part-of: cluster-logging
          app.kubernetes.io/component: collector
  ingress:
    - name: delegate-to-collector-ingress
      action: Pass  # Pass to collector NetworkPolicy
      from:
        - namespaces: {}  # Delegate decisions for traffic coming from any source
  egress:
    - name: delegate-to-collector-egress
      action: Pass  # Pass to collector NetworkPolicy
      to: # Delegate decisions for all egress traffic
        - namespaces: {} 
        - networks:
            - 0.0.0.0/0
            - ::/0
        - nodes: {}
```

==== Example: Delegating LogFileMetricExporter Ingress Traffic (`AllowIngressMetrics`)

```yaml
apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: allow-logging-lfme-delegation
spec:
  priority: 51  # Adjust based on your cluster's ANP priority scheme. Lower number means higher priority
  subject:
    pods: # Target the LFME pods in openshift-logging namespace
      namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-logging
      podSelector:
        matchLabels:
          app.kubernetes.io/name: logfilesmetricexporter
          app.kubernetes.io/instance: instance
          app.kubernetes.io/managed-by: cluster-logging-operator
          app.kubernetes.io/part-of: cluster-logging
          app.kubernetes.io/component: logfilesmetricexporter
  ingress:
    - name: delegate-to-lfme-ingress
      action: Pass  # Pass to LFME NetworkPolicy
      from:
        - namespaces: {}
```

== References

- https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/network_security/admin-network-policy#adminnetworkpolicy_ovn-k-anp[Openshift AdminNetworkPolicy]
- https://docs.openshift.com/container-platform/latest/networking/network_policy/about-network-policy.html[OpenShift Network Policy]
- https://kubernetes.io/docs/concepts/services-networking/network-policies/[Kubernetes NetworkPolicy Documentation]
